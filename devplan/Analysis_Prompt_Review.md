# 분석 프롬프트 리뷰(장단점) 및 개선안

본 문서는 “프로젝트 분석/보고서 업데이트용 분석 프롬프트”의 설계 장단점과, 실제 운영에서 실패율을 낮추기 위한 개선 권장 사항을 정리합니다.

---

## 0) 적용 현황(체크리스트)

아래는 `vibereport-extension/src/utils/analysisPromptTemplate.ts` 기준으로, 본 문서의 개선 권장 사항이 실제 “분석 프롬프트 생성기능”에 반영되었는지 점검한 결과입니다.

### ✅ 적용 완료

- [x] **언어 규칙 예외(Allowlist) 추가**: 한국어-only 파일에서도 ID/enum/경로/명령어/Mermaid 키워드 등은 영문 유지 + 번역 금지 명시
- [x] **TODO-4 문구 정렬**: TL;DR + Risk + Mapping + Trend + Summary 누락 방지용으로 TODO-4 문구를 확장
- [x] **ID SSOT 규칙 추가**: 평가 보고서 표에 등장하는 개선 ID ↔ 개선 보고서 ↔ Prompt.md 간 정합성 규칙을 명시
- [x] **Pre-flight Recon 단계 추가**: TODO-1 이전에 package.json/README/엔트리포인트 식별/검색/스크립트 실행(가능 시) 절차를 추가
- [x] **Evidence 필드 강제**: 개선 항목 템플릿에 `Evidence: 파일경로:관찰내용` 최소 1개 요구를 추가
- [x] **마커/치환 실패 복구 플로우 추가**: 마커 없으면 삽입→채우기, 치환 실패 시 열람 후 컨텍스트 재시도 규칙 추가
- [x] **민감정보 안전 규칙 추가**: 민감 파일 패턴 명시 + “열람/복사 금지(존재 언급만 허용)” 규칙 추가
- [x] **민감 파일 노출 방지 보강**: “최근 추가된 파일”/TODO-FIXME 스캔 결과에서 민감 파일은 분리 표기 및 내용 레드액트
- [x] **Prompt.md ‘English only’ 검증 기준 명확화**: 옵션 A(한글 `[가-힣]` 금지)로 기준을 고정

### ⬜ 미적용(또는 선택 사항)

- [ ] **Prompt.md ASCII-only 옵션(B) 적용**: 현재는 “한글 금지”만 강제(이모지/특수문자는 허용될 수 있음). ASCII-only로 강화하려면 규칙/검증 기준을 추가 변경 필요
- [ ] **ID Registry 파일/마커 도입**(선택): 현재는 “규칙(SSOT)으로만” 정합성을 강제. 별도 레지스트리 파일(`devplan/Improvement_ID_Registry.md`)이나 내부 섹션/마커를 도입하면 정합성 자동 검증이 더 쉬워짐
- [ ] **민감 파일 판별 로직 통합**(선택): 현재 분석 프롬프트 템플릿 내부에서 민감 파일 감지 로직을 별도 사용. `vibereport-extension/src/utils/sensitiveFilesUtils.ts`와 완전 통합하면 동작 일관성이 더 좋아짐

---

## 1) 잘 설계된 점(유지 권장)

### A. 실행 순서 강제(TODO-1~10)

- “순서 변경 금지” + “각 TODO 후 즉시 다음으로 진행” 규칙이 에이전트의 중간 중단/누락을 줄입니다.
- 3개 파일을 동일 세션에서 연속적으로 업데이트하도록 강제해 산출물 간 일관성을 확보하기 좋습니다.

### B. 마커 기반 편집(섹션 단위 교체)

- `<!-- AUTO-...-START -->` / `<!-- AUTO-...-END -->` 구간만 교체하도록 제한하면 대규모 문서 파괴를 방지합니다.
- `replace_string_in_file` 사용 시 “oldString에 3~5줄 컨텍스트 포함” 규칙은 실전에서 매칭 실패율을 줄여줍니다.

### C. 산출물 구조의 “검증 가능성”

- 점수↔등급 매핑 테이블, TL;DR 표, Risk Summary, Score↔Improvement 매핑 등은 생성 결과를 빠르게 검수하기 쉬운 구조입니다.
- 개선 보고서에 Origin/Risk/관련 평가 카테고리/DoD 등을 요구하면 근거성과 실행 가능성이 올라갑니다.

---

## 2) 실제 운영에서 문제가 될 수 있는 지점(중요)

### (1) “한국어-only” 규칙 vs 영문 enum/토큰 요구 충돌

- 한국어-only 파일에서도 다음과 같은 토큰은 사실상 영문이 필요합니다.
  - `Origin`: `test-failure` / `build-error` / `static-analysis` / `manual-idea`
  - `Risk level`: `low` / `medium` / `high` / `critical`
  - `Complexity`: `Low` / `Medium` / `High`
  - 관련 평가 카테고리 키(`testCoverage`, `codeQuality`, …)
  - Mermaid 키워드(`flowchart TB`, `subgraph`, …), 파일 경로, ID(`test-commands-001`), CLI 명령어(`pnpm run test`)
- 예외 규정이 없으면 에이전트가 영문 토큰을 한국어로 번역해 파싱/연결이 깨지거나, 반대로 규칙 위반으로 오작동할 수 있습니다.

### (2) TODO 리스트와 “필수 섹션” 요구사항 불일치

- 평가 보고서 필수 마커(예: TL;DR/Risk/Mapping/Trend)가 TODO-4 문구에 명시적으로 연결되지 않으면 누락 가능성이 커집니다.

### (3) “리스크/매핑 표의 개선 ID 정합성” 요구 vs 작성 순서 충돌

- 평가 보고서에서 개선 ID를 먼저 요구하면서(리스크/매핑), 개선 보고서는 뒤에서 ID를 정의하므로 SSOT가 모호해질 수 있습니다.

### (4) “실제 관찰된 이슈 기반” 요구의 근거 확보 절차 부족

- 어떤 파일을 우선 확인할지, 어떤 검색을 할지, 어떤 명령(build/test/lint)을 실행할지, 증거를 어떻게 남길지(파일 경로/함수/에러 메시지 등)가 절차로 고정되지 않으면 “그럴듯한 상상” 개선안이 늘어납니다.

### (5) 마커 부재/치환 실패 시 복구 플로우 부재

- 마커가 없거나, 공백/형식 차이로 치환이 실패하는 경우가 실전에서 빈번합니다.
- 복구 절차가 없으면 무한 재시도 또는 임의 수정으로 흐를 수 있습니다.

### (6) 민감정보(예: `vsctoken.txt`) 노출 위험

- “최근 추가된 파일”로 민감 파일이 언급되고 “모든 파일 리뷰”를 요구하면 토큰 내용 노출 사고로 이어질 수 있습니다.

### (7) `Prompt.md` “English only” 검증 기준 애매함

- “영문으로 작성”인지(이모지/특수문자 허용), “ASCII만 허용”인지가 불명확하면 자동 검증/운영 규칙이 흔들립니다.

---

## 3) 개선 권장 사항(효과 큰 것부터)

1) **언어 규칙 예외(Allowlist) 추가**
- 한국어-only 파일에서도 허용되는 토큰(IDs, enum 값, 파일 경로, 코드/명령어, Mermaid 키워드 등)을 명시하고 “번역 금지”로 고정합니다.
- Mermaid는 키워드(예: `flowchart`, `subgraph`)는 그대로, 노드 라벨/설명만 한국어로 작성하도록 분리 규칙을 둡니다.

2) **TODO-4 문구를 필수 섹션과 정렬**
- `TL;DR + Risk Summary + Score↔Improvement Mapping + Trend + Current State Summary`를 TODO-4에 명시해 누락을 줄입니다.

3) **ID 단일 소스(SSOT) 규칙을 명확히**
- 평가 보고서의 리스크/매핑 표에서 참조하는 모든 개선 ID가, 개선 보고서에서도 동일하게 정의/재등장하도록 강제합니다(“ID는 절대 바꾸지 말 것”).

4) **Pre-flight Recon(근거 수집) 단계 추가**
- TODO-1 시작 전에 다음을 수행하도록 규칙화합니다:
  - `package.json`/`README.md` 확인(스크립트/사용 시나리오)
  - VS Code 확장/CLI 엔트리포인트 식별
  - `TODO|FIXME|any|ts-ignore|eslint-disable` 검색
  - 가능하면 `pnpm run test/build/lint` 실행(존재하는 스크립트만)
- 개선 항목 템플릿에 **Evidence**(파일 경로 + 관찰 포인트) 최소 1개를 강제합니다.

5) **마커/치환 실패 복구 플로우 추가**
- 마커가 없으면 “삽입 → 채우기”로 복구합니다.
- 치환 실패 시 “파일 열람 후 정확한 주변 문장으로 재시도”를 규칙으로 둡니다.

6) **민감정보 안전 규칙 추가(강력 권장)**
- 토큰/키/자격증명 파일은 열지 말고, 보고서에 내용 복사 금지(존재만 언급 가능).
- 민감 파일 패턴 예: `vsctoken.txt`, `.env*`, `*token*`, `*secret*`, `*key*`, `*credential*`.

7) **`Prompt.md` “English only” 검증 기준 고정**
- 운영 관점에서 다음 중 하나로 고정:
  - 옵션 A: 한글(정규식 `[가-힣]`)만 금지
  - 옵션 B: ASCII만 허용(이모지/특수문자도 금지)

---

## 4) “개선 적용 여부” 빠른 체크

1) **정합성 체크(문서 간)**
- 평가 보고서 Risk Summary / Score Mapping에 등장하는 개선 ID가 개선 보고서에도 **동일하게 존재**하는지 확인합니다.
- 개선 보고서의 pending 항목이 `Prompt.md`에 프롬프트로 **누락 없이 생성**됐는지 확인합니다.

2) **언어 체크**
- `Prompt.md`: 한글이 단 1글자라도 들어갔는지(정규식 `[가-힣]`).
- 한국어 보고서: “예외 토큰” 외 과도한 영문 문장(설명문)이 섞이지 않았는지.

3) **도구 호출 실패 내성**
- 마커가 없을 때 “삽입→채우기”로 복구되는지.
- 치환 실패 시 무한 루프 대신 “열람→정확한 컨텍스트로 재치환”하는지.
